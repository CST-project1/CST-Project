<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../bootstrap-5.3.7-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../styles/aside.css">
    <title>Dashboard</title>
</head>

<body>
    <div class="container-fluid vh-100 d-flex p-0">

        <div id="sidebar-container"></div>

        <!-- زر الموبايل -->
        <button class="btn btn-primary d-md-none position-fixed m-3" id="mobileMenuBtn">☰</button>

        <!-- Main Content -->
        <main class="flex-grow-1 p-lg-4 p-2">

            <!-- الإحصائيات -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-sm-6 col-lg-3">
                    <a href="UsersPage.html">
                        <div class="p-3 rounded bg-success-subtle shadow-sm text-center">
                            <h3 class="fs-5">User Number</h3>
                            <p id="userCount" class="fs-3 fw-bold mt-2">0</p>
                        </div>
                    </a>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <a href="SellerPage.html">
                        <div class="p-3 rounded bg-warning-subtle shadow-sm text-center">
                            <h3 class="fs-5">Seller Number</h3>
                            <p id="sellerCount" class="fs-3 fw-bold mt-2">0</p>
                        </div>
                    </a>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <a href="OrdersPage.html">
                        <div class="p-3 rounded bg-primary-subtle shadow-sm text-center">
                            <h3 class="fs-5">Order Number</h3>
                            <p id="orderCount" class="fs-3 fw-bold mt-2">0</p>
                        </div>
                    </a>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <a href="Products.html">
                        <div class="p-3 rounded bg-danger-subtle shadow-sm text-center">
                            <h3 class="fs-5">Product Number</h3>
                            <p id="productCount" class="fs-3 fw-bold mt-2">0</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- الرسوم البيانية -->
            <div class="row g-4 mb-4">
                <div class="col-12 col-lg-6">
                    <div class="p-3 bg-white rounded shadow-sm">
                        <h5 class="mb-3">Orders by Status</h5>
                        <div style="height: 300px;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="p-3 bg-white rounded shadow-sm">
                        <h5 class="mb-3">Top Products (by Orders)</h5>
                        <div style="height: 300px;">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- المقارنة الشهرية -->
            <div class="p-3 bg-white rounded shadow-sm">
                <h5 class="mb-3">Monthly Orders</h5>
                <div style="height: 350px;">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar">
        <div class="offcanvas-header">
            <h5>Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <ul id="mobileMenuList" class="list-group list-group-flush"></ul>
        </div>
    </div>

    <script src="../../bootstrap-5.3.7-dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/aside.js"></script>

    <script>
        // -------- Get Data from localStorage --------
        const users = JSON.parse(localStorage.getItem("users")) || [];
        const sellers = users.filter(u => u.role === "Seller");
        const orders = JSON.parse(localStorage.getItem("orders")) || [];
        const products = JSON.parse(localStorage.getItem("products")) || [];

        // -------- Update Counts --------
        document.getElementById("userCount").innerText = users.length;
        document.getElementById("sellerCount").innerText = sellers.length;
        document.getElementById("orderCount").innerText = orders.length;
        document.getElementById("productCount").innerText = products.length;

        // -------- Orders by Status (Pie) --------
        let statusCount = {};
        orders.forEach(o => {
            statusCount[o.status] = (statusCount[o.status] || 0) + 1;
        });

        new Chart(document.getElementById('pieChart'), {
            type: 'pie',
            data: {
                labels: Object.keys(statusCount),
                datasets: [{
                    data: Object.values(statusCount),
                    backgroundColor: ["#4F46E5", "#10B981", "#F59E0B", "#EF4444", "#6366F1"]
                }]
            }
        });

        // -------- Top Products by Orders (Bar) --------
        let productOrderCount = {};
        orders.forEach(o => {
            let p = products.find(pr => pr.id === o.product_id);
            if (p) {
                productOrderCount[p.name] = (productOrderCount[p.name] || 0) + o.quantity;
            }
        });

        // === Top Products (by Orders) ===
        let productOrders = products.map(p => {
            return {
                name: p.name,
                id: p.id,
                ordersCount: orders.filter(o => o.product_id === p.id).length
            };
        });

        // ترتيب تنازلي حسب عدد الطلبات
        productOrders.sort((a, b) => b.ordersCount - a.ordersCount);

        // ناخد أول 5 منتجات
        let topProducts = productOrders.slice(0, 5);

        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: topProducts.map(p => `${p.name} (ID: ${p.id})`),
                datasets: [{
                    label: "Orders",
                    data: topProducts.map(p => p.ordersCount),
                    backgroundColor: ["#6366F1", "#10B981", "#F59E0B", "#EF4444", "#3B82F6"]
                }]
            }
        });


        // -------- Monthly Orders (Line) --------
        let months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug"];

        let menOrders = months.map((m, idx) =>
            orders.filter(o => {
                let p = products.find(pr => pr.id === o.product_id);
                return p && p.id % 2 === 0 && new Date(o.date).getMonth() === idx;
            }).length
        );

        let womenOrders = months.map((m, idx) =>
            orders.filter(o => {
                let p = products.find(pr => pr.id === o.product_id);
                return p && p.id % 2 !== 0 && new Date(o.date).getMonth() === idx;
            }).length
        );

        new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                        label: "Men's Perfumes",
                        data: menOrders,
                        borderColor: "#3B82F6",
                        backgroundColor: "rgba(59,130,246,0.2)"
                    },
                    {
                        label: "Women's Perfumes",
                        data: womenOrders,
                        borderColor: "#EC4899",
                        backgroundColor: "rgba(236,72,153,0.2)"
                    }
                ]
            }
        });
    </script>
</body>

</html>